# ============================================================================
# VCQ Clarification Questions: Intermediary Requirements
# Generated by: Opus (Phase 3)
# Date: 2026-01-30
# ============================================================================
# This file contains clarification questions for vendors providing intermediary
# services (connector products) on behalf of Relying Parties. Key themes include
# no-storage mandates, request/response forwarding integrity, trust anchors,
# verification operations, and user privacy protections.
# ============================================================================

schemaVersion: 1
sourceFile: requirements/intermediary.yaml
modelPasses:
  opus: true       # Completed 2026-01-30 - All intermediary requirements processed
  gemini: false    # Set to true after Gemini completes review pass

requirements:
  # ============================================================================
  # VEND-INT-001: Dual Identity Display
  # Requirement: Display both intermediary and RP identity before requesting attestations
  # ============================================================================
  VEND-INT-001:
    questions:
      - id: Q1
        text: "How do you communicate both the intermediary's identity and the ultimate Relying Party's identity to the wallet for user display?"
        dimension: technical_implementation
      - id: Q2
        text: "What data elements are included in the RP identity information (name, logo, registration status, intended use)?"
        dimension: technical_implementation
      - id: Q3
        text: "How is the RP identity information kept current when RP details change?"
        dimension: lifecycle
      - id: Q4
        text: "How do you handle cases where the wallet does not display dual identities correctly?"
        dimension: operational
      - id: Q5
        text: "Can the organization customize how their identity is presented to wallet users?"
        dimension: flexibility

  # ============================================================================
  # VEND-INT-002: Request Integrity - No Request Modification
  # Requirement: Ensure RP's intended data requests are accurately communicated to wallet
  # ============================================================================
  VEND-INT-002:
    questions:
      - id: Q1
        text: "What technical controls prevent the intermediary from modifying, expanding, or altering the RP's registered data request?"
        dimension: security
      - id: Q2
        text: "How do you validate that request forwarding only includes attributes registered by the RP?"
        dimension: compliance_monitoring
      - id: Q3
        text: "Is there an audit trail showing the RP's original request versus what was sent to the wallet?"
        dimension: auditability
      - id: Q4
        text: "What happens if an RP attempts to request attributes not authorized in their registration?"
        dimension: operational
      - id: Q5
        text: "How do you ensure alignment between registered intended uses and actual requests?"
        dimension: compliance_monitoring

  # ============================================================================
  # VEND-INT-003: Request Forwarding Integrity
  # Requirement: Forward presentation requests without modification of requested attributes
  # ============================================================================
  VEND-INT-003:
    questions:
      - id: Q1
        text: "How do you technically ensure requests are relayed to wallets without attribute modification?"
        dimension: technical_implementation
      - id: Q2
        text: "Is the request payload signed or otherwise integrity-protected during relay?"
        dimension: security
      - id: Q3
        text: "What logging exists to demonstrate request forwarding integrity?"
        dimension: auditability
      - id: Q4
        text: "How is request integrity verified at the wallet end?"
        dimension: interoperability

  # ============================================================================
  # VEND-INT-004: Response Forwarding Integrity - No Data Processing
  # Requirement: Forward wallet presentations to RP without modification
  # ============================================================================
  VEND-INT-004:
    questions:
      - id: Q1
        text: "How do you ensure wallet presentations are relayed to the RP without alteration, extraction, or processing?"
        dimension: technical_implementation
      - id: Q2
        text: "What architectural controls prevent the intermediary from accessing or analyzing presentation content?"
        dimension: architecture
      - id: Q3
        text: "Is the presentation payload encrypted end-to-end from wallet to RP, with the intermediary unable to decrypt?"
        dimension: security
      - id: Q4
        text: "What audit evidence demonstrates that credential data is not accessed during transit?"
        dimension: auditability
      - id: Q5
        text: "How would a breach of this integrity control be detected?"
        dimension: incident_response

  # ============================================================================
  # VEND-INT-005: Protocol Support (Remote and Proximity)
  # Requirement: Support both remote and proximity presentation protocols
  # ============================================================================
  VEND-INT-005:
    questions:
      - id: Q1
        text: "Do you support remote presentation via OpenID4VP as specified in ISO/IEC TS 18013-7?"
        dimension: capability
      - id: Q2
        text: "Do you support proximity presentation via BLE/NFC as specified in ISO/IEC 18013-5?"
        dimension: capability
      - id: Q3
        text: "Which wallet implementations have you tested protocol compatibility with (EUDI reference, Apple, Google, third-party)?"
        dimension: interoperability
      - id: Q4
        text: "What hardware is required for proximity presentation support at the organization's locations?"
        dimension: operational
      - id: Q5
        text: "Do you support SIOPv2 (Self-Issued OpenID Provider) as an alternative presentation protocol?"
        dimension: capability
      - id: Q6
        text: "How do you handle mode switching when both remote and proximity are available?"
        dimension: user_experience

  # ============================================================================
  # VEND-INT-006: Conditional Forwarding After Verification
  # Requirement: Forward attributes only to the requesting RP after verification
  # ============================================================================
  VEND-INT-006:
    questions:
      - id: Q1
        text: "How do you ensure attributes are forwarded ONLY to the specific RP on whose behalf the request was made?"
        dimension: security
      - id: Q2
        text: "What happens if verification fails—how is it ensured no attributes are forwarded?"
        dimension: operational
      - id: Q3
        text: "How do you prevent routing errors where data could be sent to the wrong RP?"
        dimension: security
      - id: Q4
        text: "What audit trail exists for successful and failed verification outcomes?"
        dimension: auditability

  # ============================================================================
  # VEND-INT-007: PID Provider Trusted Lists
  # Requirement: Maintain up-to-date Trusted Lists for PID Providers
  # ============================================================================
  VEND-INT-007:
    questions:
      - id: Q1
        text: "How do you obtain and maintain Trusted Lists for PID Providers from Member States?"
        dimension: technical_implementation
      - id: Q2
        text: "How frequently are Trusted Lists refreshed?"
        dimension: sla
      - id: Q3
        text: "How do you handle additions, modifications, and revocations of trust anchors?"
        dimension: lifecycle
      - id: Q4
        text: "What is the latency between a trust anchor change and your system reflecting it?"
        dimension: sla
      - id: Q5
        text: "Which Member States' Trusted Lists do you currently support?"
        dimension: geographic_scope

  # ============================================================================
  # VEND-INT-008: Attestation Provider Trusted Lists
  # Requirement: Maintain up-to-date Trusted Lists for Attestation Providers
  # ============================================================================
  VEND-INT-008:
    questions:
      - id: Q1
        text: "How do you maintain Trusted Lists for QEAA and EAA providers?"
        dimension: technical_implementation
      - id: Q2
        text: "Do you distinguish between qualified and non-qualified attestation providers in your trust store?"
        dimension: compliance_completeness
      - id: Q3
        text: "How do you handle attestation providers not yet on Trusted Lists?"
        dimension: operational
      - id: Q4
        text: "Can the organization configure additional trusted attestation providers beyond official lists?"
        dimension: flexibility

  # ============================================================================
  # VEND-INT-009: Official Trust Sources Only
  # Requirement: Obtain trust anchors only from official Trusted List sources
  # ============================================================================
  VEND-INT-009:
    questions:
      - id: Q1
        text: "How do you ensure trust anchors are obtained exclusively from official EU and Member State sources?"
        dimension: security
      - id: Q2
        text: "Do you use any third-party aggregators for trust anchor data? If so, how is their authenticity verified?"
        dimension: supply_chain
      - id: Q3
        text: "What controls prevent injection of unauthorized trust anchors into your trust store?"
        dimension: security
      - id: Q4
        text: "How is the authenticity of Trusted List downloads verified (signatures, certificates)?"
        dimension: technical_implementation

  # ============================================================================
  # VEND-INT-010: Signature Validation
  # Requirement: Validate attestation signatures using official trust anchors
  # ============================================================================
  VEND-INT-010:
    questions:
      - id: Q1
        text: "How do you verify cryptographic signatures on attestations and PIDs?"
        dimension: technical_implementation
      - id: Q2
        text: "What happens when a signature is invalid—is the presentation rejected?"
        dimension: operational
      - id: Q3
        text: "What happens when a signature is valid but the issuer is not in your trust store?"
        dimension: operational
      - id: Q4
        text: "What cryptographic libraries do you use for signature verification?"
        dimension: technical_implementation
      - id: Q5
        text: "How do you handle algorithm transitions as new algorithms are approved?"
        dimension: lifecycle

  # ============================================================================
  # VEND-INT-011: Revocation Status Verification
  # Requirement: Verify attestation revocation status before acceptance (recommended)
  # ============================================================================
  VEND-INT-011:
    questions:
      - id: Q1
        text: "Do you check attestation revocation status before accepting presentations?"
        dimension: capability
      - id: Q2
        text: "What revocation checking mechanisms do you support (status lists, OCSP, token status)?"
        dimension: technical_implementation
      - id: Q3
        text: "How do you handle revocation checking when status endpoints are unavailable?"
        dimension: operational
      - id: Q4
        text: "What is the latency impact of revocation checking on verification time?"
        dimension: sla
      - id: Q5
        text: "Can the organization configure whether revocation checking is mandatory or optional?"
        dimension: flexibility

  # ============================================================================
  # VEND-INT-012: Device Binding Verification
  # Requirement: Verify the wallet unit's device binding
  # ============================================================================
  VEND-INT-012:
    questions:
      - id: Q1
        text: "How do you verify that presentations are cryptographically bound to the presenting wallet's WSCD?"
        dimension: technical_implementation
      - id: Q2
        text: "What proof-of-possession mechanisms do you verify (device key signatures, key attestations)?"
        dimension: security
      - id: Q3
        text: "How do you detect presentations that may have been exported from the original device?"
        dimension: security
      - id: Q4
        text: "What is the failure handling when device binding verification fails?"
        dimension: operational

  # ============================================================================
  # VEND-INT-013: Replay Attack Prevention
  # Requirement: Verify presentation freshness and prevent replay attacks
  # ============================================================================
  VEND-INT-013:
    questions:
      - id: Q1
        text: "How do you verify that presentations are fresh and not replayed from previous sessions?"
        dimension: technical_implementation
      - id: Q2
        text: "What nonce or challenge mechanisms do you use?"
        dimension: security
      - id: Q3
        text: "How do you handle timestamp verification for presentation freshness?"
        dimension: technical_implementation
      - id: Q4
        text: "What is the time window for accepting presentations (tolerance for clock skew)?"
        dimension: operational
      - id: Q5
        text: "How do you detect and block replay attempts?"
        dimension: security

  # ============================================================================
  # VEND-INT-014: Secure Channel to RP
  # Requirement: Ensure secure channel for transmission to RP
  # ============================================================================
  VEND-INT-014:
    questions:
      - id: Q1
        text: "What transport layer security do you use for transmitting presentations to the RP (TLS version, cipher suites)?"
        dimension: security
      - id: Q2
        text: "Do you support mutual TLS (mTLS) for RP authentication?"
        dimension: capability
      - id: Q3
        text: "How are RP endpoints authenticated before forwarding data?"
        dimension: security
      - id: Q4
        text: "What happens if the secure channel to the RP cannot be established?"
        dimension: operational
      - id: Q5
        text: "Is application-layer encryption used in addition to transport encryption?"
        dimension: security

  # ============================================================================
  # VEND-INT-016: Secure Key Management
  # Note: VEND-INT-015 does not exist in source
  # Requirement: Implement secure key management for verification operations
  # ============================================================================
  VEND-INT-016:
    questions:
      - id: Q1
        text: "How do you securely store cryptographic material used in verification operations?"
        dimension: security
      - id: Q2
        text: "Are verification keys stored in HSMs or equivalent secure storage?"
        dimension: compliance_evidence
      - id: Q3
        text: "What access controls govern key usage?"
        dimension: security
      - id: Q4
        text: "How do you prevent unauthorized access, modification, or extraction of keys?"
        dimension: security
      - id: Q5
        text: "What is your key rotation and lifecycle management process?"
        dimension: lifecycle

  # ============================================================================
  # VEND-INT-017: Verification Result Integrity
  # Requirement: Protect verification results integrity
  # ============================================================================
  VEND-INT-017:
    questions:
      - id: Q1
        text: "How do you protect verification results from tampering before they reach the RP?"
        dimension: security
      - id: Q2
        text: "Are verification results signed or otherwise integrity-protected?"
        dimension: technical_implementation
      - id: Q3
        text: "How can the RP verify that the verification outcome is authentic and unmodified?"
        dimension: interoperability
      - id: Q4
        text: "What audit trail exists for verification decisions?"
        dimension: auditability

  # ============================================================================
  # VEND-INT-018: Verification Audit Logs
  # Requirement: Maintain audit logs of verification operations
  # ============================================================================
  VEND-INT-018:
    questions:
      - id: Q1
        text: "What verification operations are logged (timestamps, outcomes, error codes)?"
        dimension: auditability
      - id: Q2
        text: "How do you ensure logs do not contain attestation content (per no-storage mandate)?"
        dimension: privacy
      - id: Q3
        text: "How long are verification logs retained?"
        dimension: data_handling
      - id: Q4
        text: "Can logs be exported for dispute resolution or compliance audits?"
        dimension: operational
      - id: Q5
        text: "How are logs protected against tampering?"
        dimension: security

  # ============================================================================
  # VEND-INT-019: No Attribute Extraction
  # Requirement: Do not extract or log individual attribute values from presentations
  # ============================================================================
  VEND-INT-019:
    questions:
      - id: Q1
        text: "What technical controls prevent extraction of individual attribute values from presentations?"
        dimension: architecture
      - id: Q2
        text: "Are presentations treated as opaque payloads that cannot be decoded by the intermediary?"
        dimension: technical_implementation
      - id: Q3
        text: "How would attribute extraction be detected if it occurred?"
        dimension: incident_response
      - id: Q4
        text: "Do you undergo third-party audits to verify no-extraction compliance?"
        dimension: compliance_evidence

  # ============================================================================
  # VEND-INT-020: No Cross-RP Correlation
  # Requirement: Do not correlate or link user presentations across different RPs
  # ============================================================================
  VEND-INT-020:
    questions:
      - id: Q1
        text: "What technical and architectural controls prevent correlation of wallet user activity across different RPs?"
        dimension: architecture
      - id: Q2
        text: "Are RP relationships logically isolated to prevent cross-linking?"
        dimension: security
      - id: Q3
        text: "What data isolation exists between different RP tenants in your platform?"
        dimension: architecture
      - id: Q4
        text: "How would unauthorized correlation be detected?"
        dimension: incident_response
      - id: Q5
        text: "Do you undergo privacy audits verifying unlinkability?"
        dimension: compliance_evidence

  # ============================================================================
  # VEND-INT-021: Immediate Data Deletion
  # Requirement: Delete attestation data immediately after forwarding to RP
  # ============================================================================
  VEND-INT-021:
    questions:
      - id: Q1
        text: "How do you ensure complete deletion of PIDs, attestations, and user attributes immediately after forwarding to the RP?"
        dimension: technical_implementation
      - id: Q2
        text: "What is the definition of 'immediately'—what is the maximum time window?"
        dimension: sla
      - id: Q3
        text: "How is deletion verified (not just marked for deletion, but actually purged)?"
        dimension: auditability
      - id: Q4
        text: "How do you handle deletion when forwarding fails?"
        dimension: operational
      - id: Q5
        text: "Does deletion extend to all copies including memory, caches, and logs?"
        dimension: data_handling
      - id: Q6
        text: "What audit evidence demonstrates compliance with immediate deletion?"
        dimension: compliance_evidence

  # ============================================================================
  # VEND-INT-022: RP Details in Requests
  # Requirement: Specify RP details in each presentation request to wallet
  # ============================================================================
  VEND-INT-022:
    questions:
      - id: Q1
        text: "What RP details do you include in presentation requests (user-friendly name, unique ID, Registrar URL, intended use)?"
        dimension: technical_implementation
      - id: Q2
        text: "How do you obtain and maintain RP details for each intermediated RP?"
        dimension: operational
      - id: Q3
        text: "What happens when RP registration details change—how quickly is the update reflected?"
        dimension: lifecycle
      - id: Q4
        text: "Can the organization customize the user-friendly name and description shown to users?"
        dimension: flexibility

  # ============================================================================
  # VEND-INT-023: Credential Format Support
  # Requirement: Support mandatory credential formats based on supported use cases
  # ============================================================================
  VEND-INT-023:
    questions:
      - id: Q1
        text: "Do you support SD-JWT-VC format for remote presentations?"
        dimension: capability
      - id: Q2
        text: "Do you support ISO 18013-5 mDoc format for proximity presentations?"
        dimension: capability
      - id: Q3
        text: "If both remote and proximity modes are supported, are both formats fully implemented?"
        dimension: compliance_completeness
      - id: Q4
        text: "Which wallet implementations have you tested format compatibility with (EUDI reference, Apple, Google, third-party)?"
        dimension: interoperability
      - id: Q5
        text: "Have you participated in EUDI Wallet plugfest or interoperability testing events?"
        dimension: compliance_evidence

  # ============================================================================
  # VEND-INT-024: Selective Disclosure Support
  # Requirement: Support selective disclosure in both credential formats
  # ============================================================================
  VEND-INT-024:
    questions:
      - id: Q1
        text: "Does your verification implementation correctly handle selectively disclosed attributes?"
        dimension: capability
      - id: Q2
        text: "Do you support partial attribute disclosure in both mDoc and SD-JWT-VC formats?"
        dimension: technical_implementation
      - id: Q3
        text: "How do you verify presentations where only a subset of attributes is disclosed?"
        dimension: technical_implementation
      - id: Q4
        text: "What happens if an RP requests an attribute that was not disclosed?"
        dimension: operational

  # ============================================================================
  # VEND-INT-025: Cryptographic Certification
  # Requirement: Consider certification for cryptographic components
  # ============================================================================
  VEND-INT-025:
    questions:
      - id: Q1
        text: "Do you have certifications for your cryptographic implementations (FIPS 140-2/3, Common Criteria)?"
        dimension: compliance_evidence
      - id: Q2
        text: "What certified cryptographic libraries or modules do you use?"
        dimension: technical_implementation
      - id: Q3
        text: "If not currently certified, is certification on your roadmap?"
        dimension: roadmap
      - id: Q4
        text: "Can you provide certification evidence to the organization for their risk assessment?"
        dimension: documentation

  # ============================================================================
  # VEND-INT-026: Embedded Disclosure Policy Compliance
  # Requirement: Comply with embedded disclosure policies in attestations
  # ============================================================================
  VEND-INT-026:
    questions:
      - id: Q1
        text: "How do you verify RP compliance with embedded disclosure policies in attestations?"
        dimension: technical_implementation
      - id: Q2
        text: "What happens when an RP does not meet the disclosure policy conditions?"
        dimension: operational
      - id: Q3
        text: "How is the disclosure policy verification result communicated to the wallet for user display?"
        dimension: interoperability
      - id: Q4
        text: "What disclosure policy types do you support?"
        dimension: capability

  # ============================================================================
  # VEND-INT-027: WebAuthn for Pseudonyms
  # Requirement: Support WebAuthn specification for pseudonym generation
  # ============================================================================
  VEND-INT-027:
    questions:
      - id: Q1
        text: "Do you support WebAuthn-based pseudonymous authentication from wallet units?"
        dimension: capability
      - id: Q2
        text: "Which WebAuthn attestation and assertion modes do you support?"
        dimension: technical_implementation
      - id: Q3
        text: "How do you handle pseudonymous authentication without revealing user identity?"
        dimension: privacy
      - id: Q4
        text: "What WebAuthn authenticator types are supported?"
        dimension: interoperability

  # ============================================================================
  # VEND-INT-028: RP-Specific Pseudonyms
  # Requirement: Support relying-party-specific pseudonyms
  # ============================================================================
  VEND-INT-028:
    questions:
      - id: Q1
        text: "Do you correctly handle RP-specific pseudonyms generated by wallets?"
        dimension: capability
      - id: Q2
        text: "How do you ensure pseudonyms cannot be linked across different RPs using your service?"
        dimension: privacy
      - id: Q3
        text: "What technical controls prevent pseudonym correlation?"
        dimension: security
      - id: Q4
        text: "Do you maintain any mapping between pseudonyms and real identities?"
        dimension: privacy

  # ============================================================================
  # VEND-INT-029: Valid Access Certificate Usage
  # Requirement: Use valid Wallet-Relying Party Access Certificate
  # ============================================================================
  VEND-INT-029:
    questions:
      - id: Q1
        text: "How do you obtain and manage Wallet-Relying Party Access Certificates from Registrars?"
        dimension: lifecycle
      - id: Q2
        text: "How do you ensure the certificate is valid and not expired when interacting with wallets?"
        dimension: technical_implementation
      - id: Q3
        text: "What certificate lifecycle management is in place (renewal alerts, automated rotation)?"
        dimension: automation
      - id: Q4
        text: "How do wallets verify your access certificate?"
        dimension: interoperability
      - id: Q5
        text: "What happens if the access certificate is revoked or expires during operations?"
        dimension: incident_response

  # ============================================================================
  # VEND-INT-030: TS7 Data Deletion Interface
  # Requirement: Implement TS7 data deletion request interface for GDPR Article 17 compliance
  # ============================================================================
  VEND-INT-030:
    questions:
      - id: Q1
        text: "Do you implement the common data deletion request interface as specified in TS7?"
        dimension: capability
      - id: Q2
        text: "How do you authenticate users submitting deletion requests via the TS7 interface?"
        dimension: security
      - id: Q3
        text: "Given the no-storage mandate, what data is subject to deletion requests?"
        dimension: data_handling
      - id: Q4
        text: "What is your response time for processing deletion requests?"
        dimension: sla
      - id: Q5
        text: "How do you relay deletion requests to the ultimate RP when needed?"
        dimension: operational

  # ============================================================================
  # VEND-INT-031: User Reporting Support
  # Requirement: Support user reporting to data protection authorities
  # ============================================================================
  VEND-INT-031:
    questions:
      - id: Q1
        text: "How is your identity (as intermediary) presented to users and potentially included in DPA reports?"
        dimension: operational
      - id: Q2
        text: "What contact information is provided to users for complaint purposes?"
        dimension: compliance_completeness
      - id: Q3
        text: "How do you support investigation requests from data protection authorities?"
        dimension: regulatory_access
      - id: Q4
        text: "What process is in place to respond to DPA inquiries about intermediation activities?"
        dimension: incident_response

  # ============================================================================
  # VEND-INT-032: Dual Certificate Inclusion in Requests
  # Requirement: Include intermediary access certificate and RP registration certificate in requests
  # ============================================================================
  VEND-INT-032:
    questions:
      - id: Q1
        text: "Do you include both your access certificate and the intermediated RP's registration certificate in wallet requests?"
        dimension: capability
      - id: Q2
        text: "How do you obtain and maintain RP registration certificates?"
        dimension: lifecycle
      - id: Q3
        text: "What happens when an RP does not have a registration certificate?"
        dimension: operational
      - id: Q4
        text: "How are certificate updates reflected in ongoing operations?"
        dimension: lifecycle

  # ============================================================================
  # VEND-INT-033: Contractual Relationship Registration
  # Requirement: Ensure intermediary-RP contractual relationship is registered
  # ============================================================================
  VEND-INT-033:
    questions:
      - id: Q1
        text: "How do you ensure the intermediary-RP relationship is registered with the Registrar before beginning operations?"
        dimension: compliance_monitoring
      - id: Q2
        text: "What legal evidence do you provide to Registrars to establish the relationship?"
        dimension: compliance_evidence
      - id: Q3
        text: "How do you handle wallets that cannot verify the registered relationship?"
        dimension: operational
      - id: Q4
        text: "What is the timeline from contract signing to registered relationship?"
        dimension: sla
      - id: Q5
        text: "How do you manage relationship updates (new RPs, terminated RPs)?"
        dimension: lifecycle

  # ============================================================================
  # VEND-INT-034: Attestation Status List Verification
  # Requirement: Support attestation status list verification mechanisms (recommended)
  # ============================================================================
  VEND-INT-034:
    questions:
      - id: Q1
        text: "Do you support attestation status list verification as specified in ARF Topic 7?"
        dimension: capability
      - id: Q2
        text: "What status list formats do you support (Attestation Status List, Token Status List)?"
        dimension: technical_implementation
      - id: Q3
        text: "How frequently do you refresh status lists from issuers?"
        dimension: sla
      - id: Q4
        text: "What is the fallback behavior when status lists are unavailable?"
        dimension: operational
      - id: Q5
        text: "Can the organization configure revocation checking behavior (mandatory vs. optional)?"
        dimension: flexibility
