# VCQ Requirements: Payments & SCA (VEND-SCA-*)
# 
# These requirements apply to vendors providing integration products
# for Strong Customer Authentication (SCA) in electronic payments using
# EUDI Wallets. Based on PSD2 RTS 2018/389 and TS12.
#
# Legal Framework:
# - PSD2 Directive 2015/2366 (Article 97)
# - PSD2 RTS 2018/389 (Articles 4-9, 22-27)
# - TS12 (Electronic Payments SCA)
# - EUDI Wallet Reference Implementation (TS12 Protocol)
#
# Context:
# This file addresses VCQ requirements for third-party vendors/connectors
# that help PSPs integrate EUDI Wallet-based SCA. The PSP remains the
# regulated entity responsible for PSD2 compliance.
#
# Schema Version: 2
# Created: 2026-01-28
# Decision: DEC-257 (VCQ Role/Category Expansion)

schemaVersion: 2

requirements:
  # ============================================================================
  # AUTHENTICATION ELEMENTS - SCA Independence
  # ============================================================================
  
  - id: VEND-SCA-001
    category: payments
    requirement: "Ensure SCA elements derive from independent authentication factors"
    explanation: |
      When integrating EUDI Wallet for SCA, the vendor must ensure the 
      authentication derives from at least two independent elements from 
      knowledge, possession, and inherence categories. The wallet's 
      cryptographic proofs (possession) must be combined with another factor.
    legalBasis:
      regulation: "2018/389"
      article: "Article 4"
      paragraph: "1"
    legalText: |
      Payment service providers shall apply strong customer authentication 
      as defined in point (30) of Article 4 of Directive (EU) 2015/2366 
      where the payer accesses his payment account online, initiates an 
      electronic payment transaction, or carries out any action through 
      a remote channel.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-002
    category: payments
    requirement: "Support PIN/biometric entry for the knowledge/inherence factor"
    explanation: |
      The connector must support wallet-based PIN entry or biometric 
      verification to satisfy the knowledge or inherence element of SCA, 
      complementing the possession element from the WSCD.
    legalBasis:
      regulation: "2018/389"
      article: "Article 6"
      paragraph: ""
    legalText: |
      The authentication elements categorised as inherence which payment 
      service providers may use shall be based on algorithms that assess 
      the probability that the authentication element derives from the 
      payment service user.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-003
    category: payments
    requirement: "Preserve breach isolation between SCA elements"
    explanation: |
      The integration must maintain independence such that compromise of 
      one authentication element does not compromise the other. The wallet's 
      WSCD isolation supports this, but the connector must not aggregate 
      elements in a way that reduces independence.
    legalBasis:
      regulation: "2018/389"
      article: "Article 9"
      paragraph: "1"
    legalText: |
      Payment service providers shall ensure that the use of the elements 
      of strong customer authentication is subject to measures to mitigate 
      the risk of fraud due to the compromise of one of the elements.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  # ============================================================================
  # DYNAMIC LINKING - Transaction Binding
  # ============================================================================

  - id: VEND-SCA-004
    category: payments
    requirement: "Implement dynamic linking for remote payment transactions"
    explanation: |
      For remote payments, the connector must request wallet attestations 
      that dynamically link the authentication to the specific transaction 
      amount and payee. The VP Token must contain these bound elements.
    legalBasis:
      regulation: "2018/389"
      article: "Article 5"
      paragraph: "1"
    legalText: |
      Payment service providers shall apply strong customer authentication 
      that includes elements which dynamically link the transaction to a 
      specific amount and a specific payee.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-005
    category: payments
    requirement: "Include transaction amount and payee in authentication request"
    explanation: |
      The OID4VP authentication request must include the transaction amount 
      (document_number) and payee identifier in a way that enables the 
      wallet to display these to the user and bind them to the VP Token.
    legalBasis:
      regulation: "2018/389"
      article: "Article 5"
      paragraph: "2(a)"
    legalText: |
      For the purpose of paragraph 1, the payer shall be made aware of 
      the amount of the payment transaction and of the payee.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-006
    category: payments
    requirement: "Ensure authentication codes are specific and non-reusable"
    explanation: |
      The VP Token serves as the PSD2 authentication code. The connector 
      must ensure each token is bound to the specific transaction context 
      and cannot be reused for different transactions.
    legalBasis:
      regulation: "2018/389"
      article: "Article 5"
      paragraph: "3"
    legalText: |
      The authentication code accepted by the payment service provider 
      shall be specific to the amount of the transaction and the payee.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-007
    category: payments
    requirement: "Invalidate authentication codes when transaction details change"
    explanation: |
      If the payer modifies the transaction amount or payee after 
      authentication, the existing VP Token must be invalidated and 
      new SCA must be performed with the correct transaction details.
    legalBasis:
      regulation: "2018/389"
      article: "Article 5"
      paragraph: "3"
    legalText: |
      Any change to the amount or the payee shall result in the 
      invalidation of the authentication code generated.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  # ============================================================================
  # VERIFICATION - VP Token Validation
  # ============================================================================

  - id: VEND-SCA-008
    category: verification
    requirement: "Verify VP Token signatures against wallet certificate chain"
    explanation: |
      The connector must verify the cryptographic signatures on VP Tokens 
      against the wallet's certificate chain, ultimately rooted in the 
      PID Provider's trust anchor or Member State Trusted List.
    legalBasis:
      regulation: "2018/389"
      article: "Article 4"
      paragraph: "2(c)"
    legalText: |
      The elements of strong customer authentication which are independent 
      in the sense that the breach of one does not compromise the 
      reliability of the others.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-009
    category: verification
    requirement: "Check attestation revocation status before accepting transactions"
    explanation: |
      Before accepting a wallet presentation for SCA, the connector must 
      check the revocation status of the attestations presented, using 
      the issuer's published status lists.
    arfReference:
      topic: "Topic 7"
      hlr: "VCR_01"
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  # ============================================================================
  # SECURITY - Channel and Code Protection
  # ============================================================================

  - id: VEND-SCA-010
    category: security
    requirement: "Protect confidentiality of authentication elements in transit"
    explanation: |
      All communication between the connector and wallet, and between the 
      connector and PSP backend, must use encrypted channels (TLS 1.2+) 
      to protect authentication elements from interception.
    legalBasis:
      regulation: "2018/389"
      article: "Article 22"
      paragraph: "1"
    legalText: |
      Payment service providers shall ensure the confidentiality, 
      authenticity and integrity of payment service users' personalised 
      security credentials.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: critical

  - id: VEND-SCA-011
    category: security
    requirement: "Implement rate limiting and lockout for failed authentications"
    explanation: |
      The connector must implement or support rate limiting and account 
      lockout mechanisms after repeated failed authentication attempts, 
      protecting against brute-force attacks.
    legalBasis:
      regulation: "2018/389"
      article: "Article 4"
      paragraph: "3"
    legalText: |
      Payment service providers shall adopt strong customer authentication 
      procedures including elements to prevent the use of compromised 
      authentication elements.
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: high

  - id: VEND-SCA-012
    category: security
    requirement: "Log authentication events for audit and fraud detection"
    explanation: |
      The connector should log authentication events (success, failure, 
      timeout) with sufficient detail to support fraud investigation and 
      regulatory audit requirements, while respecting data minimisation.
    legalBasis:
      regulation: "2018/389"
      article: "Article 23"
      paragraph: ""
    roles: [relying_party]
    productCategories: [connector]
    deadline: "2027-11-21"
    criticality: high
